@page "/admin/servers/images/{Id:int}/variables"

@using Moonlight.Features.Servers.Entities
@using Moonlight.Core.Repositories
@using Moonlight.Features.Servers.UI.Components
@using Microsoft.EntityFrameworkCore
@using BlazorTable
@using Moonlight.Features.Servers.Models.Forms.Admin.Images

@inject Repository<ServerImage> ImageRepository

<LazyLoader ShowAsCard="true" Load="Load">
    @if (Image == null)
    {
        <NotFoundAlert/>
    }
    else
    {
        <AdminImageViewNavigation Index="5" ImageId="@Id"/>

        <AutoListCrud TItem="ServerImageVariable"
                      TRootItem="ServerImage"
                      TCreateForm="CreateImageVariable"
                      TUpdateForm="UpdateImageVariable"
                      Field="@(x => x.Variables)"
                      RootItem="Image"
                      Title="Manage image variables">
            <View>
                <Column TableItem="ServerImageVariable" Field="@(x => x.Id)" Title="Id"/>
                <Column TableItem="ServerImageVariable" Field="@(x => x.DisplayName)" Title="Display name"/>
                <Column TableItem="ServerImageVariable" Field="@(x => x.Key)" Title="Key"/>
                <Column TableItem="ServerImageVariable" Field="@(x => x.DefaultValue)" Title="Default value"/>
                <Column TableItem="ServerImageVariable" Field="@(x => x.AllowUserToView)" Title="View">
                    <Template>
                        @if (context.AllowUserToView)
                        {
                            <i class="bx bx-sm bx-check text-success"></i>
                        }
                        else
                        {
                            <i class="bx bx-sm bx-x text-danger"></i>
                        }
                    </Template>
                </Column>
                <Column TableItem="ServerImageVariable" Field="@(x => x.AllowUserToEdit)" Title="Edit">
                    <Template>
                        @if (context.AllowUserToEdit)
                        {
                            <i class="bx bx-sm bx-check text-success"></i>
                        }
                        else
                        {
                            <i class="bx bx-sm bx-x text-danger"></i>
                        }
                    </Template>
                </Column>
            </View>
        </AutoListCrud>
    }
</LazyLoader>

@code
{
    [Parameter] public int Id { get; set; }

    private ServerImage? Image;

    private Task Load(LazyLoader arg)
    {
        Image = ImageRepository
            .Get()
            .Include(x => x.Variables)
            .FirstOrDefault(x => x.Id == Id);

        return Task.CompletedTask;
    }
}