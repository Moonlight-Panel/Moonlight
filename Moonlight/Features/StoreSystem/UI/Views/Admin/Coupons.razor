@page "/admin/store/coupons"

@using BlazorTable
@using MoonCore.Abstractions
@using MoonCore.Exceptions

@using Moonlight.Core.Extensions.Attributes
@using Moonlight.Core.Models.Enums

@using Moonlight.Features.StoreSystem.Entities
@using Moonlight.Features.StoreSystem.Models.Forms
@using Moonlight.Features.StoreSystem.UI.Components

@attribute [RequirePermission(Permission.AdminStore)]

@inject Repository<Coupon> CouponRepository

<AdminStoreNavigation Index="1"/>

<div class="mt-5">
    <AutoCrud TItem="Coupon"
              TCreateForm="AddCouponForm"
              TUpdateForm="EditCouponForm"
              Title="Manage coupons"
              Load="LoadData"
              ValidateAdd="Validate"
              ValidateUpdate="Validate">
        <View>
            <Column TableItem="Coupon" Title="Id" Field="@(x => x.Id)" Sortable="true" Filterable="true"/>
            <Column TableItem="Coupon" Title="Code" Field="@(x => x.Code)" Sortable="true" Filterable="true"/>
            <Column TableItem="Coupon" Title="Amount" Field="@(x => x.Amount)" Sortable="true" Filterable="true"/>
            <Column TableItem="Coupon" Title="Percent" Field="@(x => x.Percent)" Sortable="true" Filterable="true"/>
            <Pager ShowPageNumber="true" ShowTotalCount="true" AlwaysShow="true"/>
        </View>
    </AutoCrud>
</div>

@code
{
    private Coupon[] LoadData(Repository<Coupon> repository)
    {
        return repository
            .Get()
            .ToArray();
    }

    private Task Validate(Coupon coupon)
    {
        if (CouponRepository.Get().Any(x => x.Code == coupon.Code && x.Id != coupon.Id))
            throw new DisplayException("A coupon with that code does already exist");

        return Task.CompletedTask;
    }
}