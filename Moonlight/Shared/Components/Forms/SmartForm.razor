@using Moonlight.App.Helpers

<div class="form">
    <EditForm @ref="EditForm" Model="Model" OnValidSubmit="ValidSubmit" OnInvalidSubmit="InvalidSubmit">
        <DataAnnotationsValidator></DataAnnotationsValidator>
        @if (ErrorMessages.Any())
        {
            <div class="alert alert-danger p-10 mb-3">
                @foreach (var msg in ErrorMessages)
                {
                    <TL>@(msg)</TL>
                    <br/>
                }
            </div>
        }
        @(ChildContent)
    </EditForm>
</div>

@code
{
    [Parameter]
    public object Model { get; set; }
    
    [Parameter] 
    public EventCallback<EditContext> OnValidSubmit { get; set; }
    
    [Parameter]
    public EventCallback<EditContext> OnInvalidSubmit { get; set; }
    
    [Parameter]
    public EventCallback<EditContext> OnSubmit { get; set; }
    
    [Parameter]
    public RenderFragment ChildContent { get; set; }

    private EditForm EditForm;

    private List<string> ErrorMessages = new();

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            EditForm.EditContext!.SetFieldCssClassProvider(new FieldCssHelper());
        }
    }

    private async Task ValidSubmit(EditContext context)
    {
        ErrorMessages.Clear();
        await InvokeAsync(StateHasChanged);

        await OnValidSubmit.InvokeAsync(context);
        await OnSubmit.InvokeAsync(context);
    }

    private async Task InvalidSubmit(EditContext context)
    {
        ErrorMessages.Clear();
        context.Validate();

        foreach (var message in context.GetValidationMessages())
        {
            ErrorMessages.Add(message);
        }

        await InvokeAsync(StateHasChanged);
        
        await OnInvalidSubmit.InvokeAsync(context);
        await OnSubmit.InvokeAsync(context);
    }
}