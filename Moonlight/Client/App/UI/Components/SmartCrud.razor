@using MoonCore.Helpers
@using Moonlight.Client.App.Models.Crud
@using Moonlight.Client.App.Services
@using Moonlight.Client.App.UI.Components.Modals

@typeparam TItem
@typeparam TCreateForm
@typeparam TUpdateForm

@inject ModalService ModalService
@inject ToastService ToastService
@inject AlertService AlertService

<div class="bg-slate-800 rounded-lg">
    <div class="flex flex-col md:flex-row items-center justify-between space-y-3 md:space-y-0 md:space-x-4 p-2.5">
        <div class="w-full md:w-1/2">
            <div class="flex items-center">
                @if (Options.LoaderWithSearch != null)
                {
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <svg aria-hidden="true" class="w-5 h-5 text-slate-400" fill="currentColor" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <input type="text" class="border-0 text-sm rounded-lg block w-full pl-10 p-2 bg-slate-700 placeholder-slate-400 text-white ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-indigo-500" placeholder="Search">
                    </div>
                }
            </div>
        </div>
        <div class="w-full md:w-auto flex flex-col md:flex-row space-y-2 md:space-y-0 items-stretch md:items-center justify-end md:space-x-3 flex-shrink-0">
            <button @onclick="LaunchCreate" type="button" class="flex items-center justify-center text-white font-medium rounded-lg text-sm px-4 py-2 bg-blue-600 hover:bg-blue-700 focus:outline-none">
                <svg class="h-3.5 w-3.5 mr-2" fill="currentColor" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path clip-rule="evenodd" fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                </svg>
                Create
            </button>

            @if (Actions != null)
            {
                @Actions
            }

            <DropdownButton Text="Actions">
                <a @onclick="StartDeleteSection" @onclick:preventDefault href="#" class="block px-4 py-2 text-sm text-white" role="menuitem">
                    Delete selection
                </a>

                @if (SelectionActions != null)
                {
                    @SelectionActions.Invoke(SelectedItems.ToArray())
                }
            </DropdownButton>
        </div>
    </div>

    <SmartTable2 @ref="Table" TItem="TItem" ItemsCallback="Options.Loader" DisableHeadRounding="true">
        <SmartColumn TItem="TItem" HeadCssClasses="pl-2 w-5" CssClasses="pl-2 w-5">
            <HeadTemplate>
                @if (SelectedItems.Count == Table.CurrentItems.Length)
                {
                    <input @onclick="() => ChangeAllSelection(false)" checked="checked" type="checkbox" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-indigo-600 focus:ring-indigo-600">
                }
                else
                {
                    <input @onclick="() => ChangeAllSelection(true)" type="checkbox" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-indigo-600 focus:ring-indigo-600">
                }
            </HeadTemplate>
            <Template>
                @if (SelectedItems.Contains(context))
                {
                    <input @onclick="() => ChangeSelection(context, false)" checked="checked" type="checkbox" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-indigo-600 focus:ring-indigo-600">
                }
                else
                {
                    <input @onclick="() => ChangeSelection(context, true)" type="checkbox" class="h-4 w-4 rounded bg-slate-900 border-slate-700 text-indigo-600 focus:ring-indigo-600">
                }
            </Template>
        </SmartColumn>

        @View

        <SmartColumn TItem="TItem">
            <Template>
                <div class="flex justify-end items-center">
                    <a @onclick:preventDefault @onclick="() => LaunchUpdate(context)" href="#" class="text-blue-500 hover:underline mr-5">Edit</a>
                    <a @onclick:preventDefault @onclick="() => LaunchDelete(context)" href="#">
                        <i class="bi bi-trash3-fill text-xl text-red-500"></i>
                    </a>
                </div>
            </Template>
        </SmartColumn>
    </SmartTable2>
</div>

@code
{
    [Parameter] public RenderFragment View { get; set; }
    [Parameter] public Action<CrudOptions<TItem, TCreateForm, TUpdateForm>> OnConfigure { get; set; }

    [Parameter] public RenderFragment<TItem[]>? SelectionActions { get; set; }
    [Parameter] public RenderFragment? Actions { get; set; }

    private CrudOptions<TItem, TCreateForm, TUpdateForm> Options = new();

    private SmartTable2<TItem> Table;

    private List<TItem> SelectedItems = new();
    private TItem ItemToUpdate;

    protected override void OnInitialized()
    {
        OnConfigure.Invoke(Options);
    }

    private async Task RefreshView()
    {
        SelectedItems.Clear();
        await Table.Refresh();

        await InvokeAsync(StateHasChanged);
    }

    #region Create

    private async Task LaunchCreate()
    {
        await ModalService.Launch<FormModal<TCreateForm>>(buildAttributes: parameters =>
        {
            parameters.Add("Title", "Create");
            parameters.Add("Form", Activator.CreateInstance<TCreateForm>()!);
            parameters.Add("OnConfigure", Options.OnConfigureCreate);
            parameters.Add("OnSubmit", (Func<TCreateForm, Task>)RunCreate);
        });
    }

    private async Task RunCreate(TCreateForm form)
    {
        await Options.CreateFunction.Invoke(form);

        await ToastService.Success("Successfully added item");
        await RefreshView();
    }

    #endregion

    #region Delete

    private async Task LaunchDelete(TItem item)
    {
        await AlertService.DangerConfirm("Do you really want to delete this item?",
            () => RunDelete(item),
            "bi bi-trash3-fill"
        );
    }

    private async Task RunDelete(TItem item)
    {
        await Options.DeleteFunction.Invoke(item);

        await ToastService.Success("Successfully deleted item");
        await RefreshView();
    }

    private async Task StartDeleteSection()
    {
        if (SelectedItems.Count == 0)
            return;

        await AlertService.DangerConfirm($"Do you really want to delete {SelectedItems.Count} item(s)?",
            RunDeleteSelection,
            "bi bi-trash3-fill"
        );
    }

    private async Task RunDeleteSelection()
    {
        var count = SelectedItems.Count;

        foreach (var item in SelectedItems)
            await Options.DeleteFunction.Invoke(item);

        await ToastService.Success($"Successfully deleted {count} item(s)");
        await RefreshView();
    }

    #endregion

    #region Update

    private async Task LaunchUpdate(TItem item)
    {
        ItemToUpdate = item;

        await ModalService.Launch<FormModal<TUpdateForm>>(buildAttributes: parameters =>
        {
            parameters.Add("Title", "Update");
            parameters.Add("Form", Mapper.Map<TUpdateForm>(item!)!);
            parameters.Add("OnConfigure", Options.OnConfigureUpdate);
            parameters.Add("OnSubmit", (Func<TUpdateForm, Task>)RunUpdate);
        });
    }

    private async Task RunUpdate(TUpdateForm form)
    {
        await Options.UpdateFunction.Invoke(form, ItemToUpdate);

        await ToastService.Success("Successfully updated item");
        await RefreshView();
    }

    #endregion

    #region Selection

    private Task ChangeSelection(TItem item, bool isSelected)
    {
        if (isSelected)
        {
            if (!SelectedItems.Contains(item))
                SelectedItems.Add(item);
        }
        else
        {
            if (SelectedItems.Contains(item))
                SelectedItems.Remove(item);
        }

        return Task.CompletedTask;
    }

    private Task ChangeAllSelection(bool isSelected)
    {
        SelectedItems.Clear();

        if (isSelected)
            SelectedItems.AddRange(Table.CurrentItems);

        return Task.CompletedTask;
    }

    #endregion

}